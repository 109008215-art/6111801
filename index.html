<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音樂節奏遊戲 (簡易版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation; /* 提升移動設備反應速度 */
        }
        .game-container {
            height: 90vh;
            max-height: 800px;
            width: 100%;
            max-width: 450px; /* 調整寬度以容納4軌 */
        }
        .lane {
            position: relative;
            height: 100%;
            border-left: 1px solid #374151; /* gray-700 */
            border-right: 1px solid #374151; /* gray-700 */
        }
        .lane:first-child { border-left: 3px solid #4B5563; } /* gray-600 */
        .lane:last-child { border-right: 3px solid #4B5563; } /* gray-600 */

        .note {
            position: absolute;
            width: 95%;
            left: 2.5%;
            height: 40px;
            background: linear-gradient(180deg, #3b82f6, #1e40af);
            border: 1px solid #60a5fa;
            border-radius: 6px;
            box-shadow: 0 0 15px #3b82f6, inset 0 0 5px #dbeafe;
        }

        .target-line {
            position: absolute;
            bottom: 10%;
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, #f472b6, #a78bfa, #3b82f6, #22d3ee);
            border-radius: 5px;
            box-shadow: 0 0 20px #a78bfa;
        }
        
        .key-indicator {
            position: absolute;
            bottom: 2%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 12px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            font-weight: bold;
            color: white;
            font-size: 1.5rem;
        }
        
        .feedback {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            font-weight: bold;
            color: #22d3ee; /* cyan-400 */
            text-shadow: 0 0 10px #22d3ee;
            opacity: 0;
            transition: all 0.3s ease-out;
        }
        .feedback.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-20px);
        }
        
        .lane.active {
            background-color: rgba(59, 130, 246, 0.3);
        }

        .modal {
            background-color: rgba(17, 24, 39, 0.9);
        }

        .song-select-btn {
            background-color: #374151; /* gray-700 */
            border: 2px solid #4b5563; /* gray-600 */
            transition: all 0.2s;
        }
        .song-select-btn:hover {
            background-color: #4b5563; /* gray-600 */
            border-color: #6b7280; /* gray-500 */
        }
        .song-select-btn.selected {
            background-color: #3b82f6; /* blue-500 */
            border-color: #60a5fa; /* blue-400 */
            box-shadow: 0 0 15px #3b82f6;
        }

    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-2 sm:p-4">

    <div id="game-info" class="w-full max-w-lg mb-4 flex justify-between items-center px-2">
        <div>
            <h1 class="text-3xl font-bold text-cyan-400" style="text-shadow: 0 0 10px #22d3ee;">音樂節奏</h1>
            <p class="text-gray-400 hidden sm:block">按下對應的 D F J K 鍵來打擊音符！</p>
        </div>
        <div class="text-right">
            <div class="text-2xl font-bold">分數: <span id="score">0</span></div>
            <div class="text-lg text-pink-400">連擊: <span id="combo">0</span></div>
        </div>
    </div>

    <div id="game-container" class="game-container bg-gray-800 rounded-lg shadow-2xl overflow-hidden relative border-4 border-gray-600">
        <div class="flex h-full">
            <div class="lane w-1/4" data-lane="0"><div class="key-indicator">D</div></div>
            <div class="lane w-1/4" data-lane="1"><div class="key-indicator">F</div></div>
            <div class="lane w-1/4" data-lane="2"><div class="key-indicator">J</div></div>
            <div class="lane w-1/4" data-lane="3"><div class="key-indicator">K</div></div>
        </div>
        <div class="target-line"></div>
        <div id="feedback" class="feedback">完美</div>
    </div>

    <!-- 遊戲開始/結束 Modal -->
    <div id="modal" class="absolute inset-0 flex items-center justify-center modal z-10 transition-opacity duration-500 ease-in-out">
        <div class="text-center p-8 bg-gray-800 rounded-xl shadow-lg border border-cyan-400 max-w-sm w-full">
            <h2 id="modal-title" class="text-4xl font-bold mb-2 text-cyan-300">音樂節奏遊戲</h2>
            <p id="final-score" class="text-3xl font-bold mb-2 text-white opacity-0 transition-opacity duration-500"></p>
            <div id="song-selection" class="mb-6 transition-opacity duration-500">
                <p class="text-gray-300 mb-4">選擇一首歌曲：</p>
                <div id="song-list" class="flex flex-col gap-3">
                    <!-- Song buttons will be generated here by JS -->
                </div>
            </div>
            <p id="modal-message" class="text-red-400 h-6 mb-2"></p>
            <button id="start-button" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-xl transition duration-300 transform hover:scale-105">
                開始遊戲
            </button>
        </div>
    </div>

    <script>
        const gameContainer = document.getElementById('game-container');
        const scoreDisplay = document.getElementById('score');
        const comboDisplay = document.getElementById('combo');
        const lanes = document.querySelectorAll('.lane');
        const feedbackEl = document.getElementById('feedback');
        
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const finalScoreText = document.getElementById('final-score');
        const startButton = document.getElementById('start-button');
        const songListContainer = document.getElementById('song-list');
        const modalMessage = document.getElementById('modal-message');
        const songSelection = document.getElementById('song-selection');

        let score = 0;
        let combo = 0;
        let notes = [];
        let gameLoopInterval;
        let noteSpawnTimeouts = [];
        let gameStarted = false;
        let currentSongData = null;

        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "fmsine" },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.5 },
            volume: -10
        }).toDestination();

        const keyMap = { 'd': 0, 'f': 1, 'j': 2, 'k': 3 };
        
        const songs = {
            daoXiang: {
                name: '稻香 - 周杰倫',
                data: [
                    // 4-key easy version
                    { time: 500, lane: 2, note: "G4" }, { time: 1000, lane: 2, note: "A4" }, { time: 1500, lane: 3, note: "B4" },
                    { time: 2000, lane: 3, note: "B4" }, { time: 2500, lane: 2, note: "A4" }, { time: 3000, lane: 2, note: "G4" },
                    { time: 3500, lane: 1, note: "E4" }, { time: 4000, lane: 2, note: "G4" }, { time: 4500, lane: 2, note: "A4" },
                    { time: 5000, lane: 3, note: "B4" }, { time: 5500, lane: 3, note: "B4" }, { time: 6000, lane: 2, note: "A4" },
                    { time: 6500, lane: 2, note: "G4" }, { time: 7000, lane: 0, note: "D4" }, { time: 7500, lane: 1, note: "E4" },
                    { time: 8000, lane: 1, note: "E4" }, { time: 8500, lane: 2, note: "G4" }, { time: 9000, lane: 1, note: "E4" },
                    { time: 9500, lane: 0, note: "D4" }
                ]
            },
            aLittleHappiness: {
                name: '小幸運 - 田馥甄',
                data: [
                    // 4-key easy version
                    { time: 500, lane: 3, note: "C5" }, { time: 1000, lane: 3, note: "B4" }, { time: 1500, lane: 2, note: "A4" },
                    { time: 2000, lane: 1, note: "G4" }, { time: 2500, lane: 1, note: "G4" }, { time: 3000, lane: 2, note: "A4" },
                    { time: 3500, lane: 1, note: "G4" }, { time: 4000, lane: 0, note: "F4" }, { time: 4500, lane: 1, note: "E4" },
                    { time: 5500, lane: 1, note: "E4" }, { time: 6000, lane: 1, note: "F4" }, { time: 6500, lane: 2, note: "G4" },
                    { time: 7000, lane: 2, note: "A4" }, { time: 7500, lane: 1, note: "G4" }, { time: 8000, lane: 0, note: "F4" }
                ]
            },
            twinkleStar: {
                name: '小星星',
                data: [
                     // 4-key easy version
                    { time: 500, lane: 0, note: "C4" }, { time: 1000, lane: 0, note: "C4" }, { time: 1500, lane: 2, note: "G4" }, { time: 2000, lane: 2, note: "G4" },
                    { time: 2500, lane: 3, note: "A4" }, { time: 3000, lane: 3, note: "A4" }, { time: 3500, lane: 2, note: "G4" },
                    { time: 4500, lane: 1, note: "F4" }, { time: 5000, lane: 1, note: "F4" }, { time: 5500, lane: 0, note: "E4" }, { time: 6000, lane: 0, note: "E4" },
                    { time: 6500, lane: 1, note: "D4" }, { time: 7000, lane: 1, note: "D4" }, { time: 7500, lane: 0, note: "C4" }
                ]
            },
            jingleBells: {
                name: '聖誕鈴聲',
                data: [
                    // 4-key easy version
                    { time: 500, lane: 1, note: "E4" }, { time: 1000, lane: 1, note: "E4" }, { time: 1500, lane: 1, note: "E4" },
                    { time: 2500, lane: 1, note: "E4" }, { time: 3000, lane: 1, note: "E4" }, { time: 3500, lane: 1, note: "E4" },
                    { time: 4500, lane: 1, note: "E4" }, { time: 5000, lane: 2, note: "G4" }, { time: 5500, lane: 0, note: "C4" },
                    { time: 6000, lane: 1, note: "D4" }, { time: 6500, lane: 1, note: "E4" },
                    { time: 7500, lane: 1, note: "F4" }, { time: 8000, lane: 1, note: "F4" }, { time: 8500, lane: 1, note: "F4" },
                    { time: 9500, lane: 1, note: "F4" }, { time: 10000, lane: 1, note: "E4" }, { time: 10500, lane: 1, note: "E4" },
                    { time: 11500, lane: 2, note: "G4" }, { time: 12000, lane: 2, note: "G4" }, { time: 12500, lane: 1, note: "D4" },
                    { time: 13000, lane: 0, note: "C4" }
                ]
            }
        };

        const noteFallSpeed = 3000; // 音符從頂部到底部所需的時間 (ms), 增加時間使其變慢
        
        function populateSongList() {
            songListContainer.innerHTML = '';
            // 將歌曲物件轉換為陣列以便排序
            const songArray = Object.keys(songs).map(songId => ({
                id: songId,
                name: songs[songId].name
            }));

            songArray.forEach((songData, index) => {
                const song = songs[songData.id];
                const button = document.createElement('button');
                button.textContent = song.name;
                button.classList.add('w-full', 'py-2', 'px-4', 'rounded-lg', 'font-semibold', 'song-select-btn');
                button.dataset.songId = songData.id;

                button.addEventListener('click', () => {
                    currentSongData = song.data;
                    document.querySelectorAll('.song-select-btn').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                });
                
                songListContainer.appendChild(button);

                if (index === 0) {
                    button.click(); // 預設選擇第一首歌
                }
            });
        }


        function createNote(laneIndex, pitch) {
            const noteEl = document.createElement('div');
            noteEl.classList.add('note');
            noteEl.style.top = '-40px'; // Match height
            
            const note = { element: noteEl, lane: laneIndex, position: -40, pitch: pitch, hit: false, startTime: Date.now() };
            
            lanes[laneIndex].appendChild(noteEl);
            notes.push(note);
        }

        function gameLoop() {
            if (!gameStarted) return;
            
            const containerHeight = gameContainer.clientHeight;

            for (let i = notes.length - 1; i >= 0; i--) {
                const note = notes[i];
                if (note.hit) continue;

                const elapsedTime = Date.now() - note.startTime;
                note.position = (elapsedTime / noteFallSpeed) * containerHeight - 40; // Match height
                note.element.style.transform = `translateY(${note.position}px)`;

                if (note.position > containerHeight) {
                    note.element.remove();
                    notes.splice(i, 1);
                    if (!note.hit) {
                        endGame();
                    }
                }
            }
        }

        function handleHit(laneIndex) {
            if (!gameStarted) return;

            const targetPosition = gameContainer.clientHeight * 0.9;
            const perfectTolerance = gameContainer.clientHeight * 0.08; // 稍微放寬判定
            const goodTolerance = gameContainer.clientHeight * 0.15; // 稍微放寬判定

            let noteToHit = null;
            let minDistance = Infinity;

            // Find the closest note in the correct lane that hasn't been hit
            for (const note of notes) {
                if (note.lane === laneIndex && !note.hit) {
                    const distance = Math.abs(note.position - targetPosition);
                    if (distance < minDistance && distance < goodTolerance) { // Only consider notes within tolerance
                        minDistance = distance;
                        noteToHit = note;
                    }
                }
            }
            
            if (noteToHit) {
                noteToHit.hit = true;
                
                if (minDistance < perfectTolerance) {
                    score += 100;
                    showFeedback('完美!');
                } else {
                    score += 50;
                    showFeedback('不錯!');
                }
                combo++;
                
                synth.triggerAttackRelease(noteToHit.pitch, "8n", Tone.now());
                
                // Visual feedback for hit
                noteToHit.element.style.background = 'linear-gradient(45deg, #a78bfa, #f472b6)';
                noteToHit.element.style.boxShadow = '0 0 20px #f472b6';
                noteToHit.element.style.transition = 'all 0.1s ease-out';
                noteToHit.element.style.transform = `translateY(${noteToHit.position}px) scale(1.2)`;
                noteToHit.element.style.opacity = '0';
                
                setTimeout(() => {
                    if (noteToHit.element.parentElement) {
                        noteToHit.element.remove();
                    }
                    notes = notes.filter(n => n !== noteToHit);
                }, 100);

            }
            updateDisplay();
        }

        function showFeedback(text) {
            feedbackEl.textContent = text;
            feedbackEl.classList.add('show');
            setTimeout(() => {
                feedbackEl.classList.remove('show');
            }, 300);
        }

        function updateDisplay() {
            scoreDisplay.textContent = score;
            comboDisplay.textContent = combo;
        }
        
        function activateLane(laneIndex) {
            lanes[laneIndex].classList.add('active');
            setTimeout(() => lanes[laneIndex].classList.remove('active'), 100);
        }

        function startGame() {
            if (!currentSongData) {
                modalMessage.textContent = '請先選擇一首歌曲！';
                setTimeout(() => {
                    modalMessage.textContent = '';
                }, 2500);
                return;
            }
            
            // 重設狀態
            modalMessage.textContent = '';
            score = 0;
            combo = 0;
            notes.forEach(note => note.element.remove());
            notes = [];
            updateDisplay();

            // 淡出 modal 並在動畫後開始遊戲
            modal.classList.add('opacity-0', 'pointer-events-none');
            
            setTimeout(() => {
                gameStarted = true;
                
                // 為下次遊戲結束重設 modal
                modalTitle.textContent = '音樂節奏遊戲';
                finalScoreText.classList.add('opacity-0');
                songSelection.classList.remove('opacity-0');

                Tone.start();

                noteSpawnTimeouts.forEach(clearTimeout);
                noteSpawnTimeouts = [];

                currentSongData.forEach(noteInfo => {
                    const timeoutId = setTimeout(() => {
                        if(gameStarted) createNote(noteInfo.lane, noteInfo.note);
                    }, noteInfo.time);
                    noteSpawnTimeouts.push(timeoutId);
                });

                // 新增歌曲完成的計時器
                if (currentSongData.length > 0) {
                    const lastNote = currentSongData.reduce((max, note) => note.time > max.time ? note : max, currentSongData[0]);
                    const songDuration = lastNote.time + noteFallSpeed + 500; // 500ms 緩衝讓音符滑出螢幕
                    const successTimeout = setTimeout(() => {
                        if (gameStarted) {
                            endGame(true); // 以成功狀態結束遊戲
                        }
                    }, songDuration);
                    noteSpawnTimeouts.push(successTimeout);
                }
                
                if (gameLoopInterval) clearInterval(gameLoopInterval);
                gameLoopInterval = setInterval(gameLoop, 1000 / 60);
            }, 500); // 等待 modal 淡出
        }

        function endGame(isSuccess = false) {
            if (!gameStarted) return;
            gameStarted = false;
            clearInterval(gameLoopInterval);
            noteSpawnTimeouts.forEach(clearTimeout);
            noteSpawnTimeouts = [];

            if (!isSuccess) {
                showFeedback('錯過了!');
                combo = 0;
                updateDisplay();
            }

            // 立即顯示選單/結果畫面
            modalTitle.textContent = isSuccess ? '演奏完成!' : '遊戲結束';
            finalScoreText.textContent = `最終分數: ${score}`;
            finalScoreText.classList.remove('opacity-0');
            startButton.textContent = '開始遊戲'; // 將按鈕文字恢復預設，以便選擇新歌曲
            
            modal.classList.remove('opacity-0', 'pointer-events-none');
        }

        window.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const lane = keyMap[e.key.toLowerCase()];
            if (lane !== undefined) {
                handleHit(lane);
                activateLane(lane);
            }
        });
        
        lanes.forEach(lane => {
            const laneIndex = parseInt(lane.dataset.lane);
            lane.addEventListener('mousedown', () => { handleHit(laneIndex); activateLane(laneIndex); });
            lane.addEventListener('touchstart', (e) => { e.preventDefault(); handleHit(laneIndex); activateLane(laneIndex); });
        });
        
        startButton.addEventListener('click', startGame);
        
        // 初始化
        populateSongList();
    </script>
</body>
</html>

